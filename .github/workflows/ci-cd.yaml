name: DevOps Quest CI/CD (with Trivy Scan)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted # Note: will use the self-hosted runner

    steps:
    - name: 1. Check out code
      uses: actions/checkout@v4

    - name: 2. Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # --- Vote Service ---
    - name: 3. Build 'vote' image
      uses: docker/build-push-action@v5
      with:
        context: ./vote
        file: ./vote/Dockerfile
        push: false # Do not push now
        load: true  # Load the image locally into the runner
        tags: ramzyahmed/vote:latest

    - name: 4. Scan 'vote' image with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ramzyahmed/vote:latest'
        format: 'table'
        exit-code: '1' # Fail the pipeline if vulnerabilities are found
        ignore-unfixed: true # Ignore vulnerabilities without fixes
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH' # Only fail for Critical and High severity vulnerabilities

    - name: 5. Push 'vote' image
      run: docker push ramzyahmed/vote:latest

    # --- Result Service ---
    - name: 6. Build 'result' image
      uses: docker/build-push-action@v5
      with:
        context: ./result
        file: ./result/Dockerfile
        push: false
        load: true
        tags: ramzyahmed/result:latest

    - name: 7. Scan 'result' image with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ramzyahmed/result:latest'
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'

    - name: 8. Push 'result' image
      run: docker push ramzyahmed/result:latest

    # --- Worker Service ---
    - name: 9. Build 'worker' image
      uses: docker/build-push-action@v5
      with:
        context: ./worker
        file: ./worker/Dockerfile
        push: false
        load: true
        tags: ramzyahmed/worker:latest

    - name: 10. Scan 'worker' image with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ramzyahmed/worker:latest'
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'

    - name: 11. Push 'worker' image
      run: docker push ramzyahmed/worker:latest

    # --- Deploy ---
    - name: 12. Apply Kubernetes manifests
      run: |
        kubectl apply -f k8s/
        
    - name: 13. Force restart deployments
      run: |
        kubectl rollout restart deployment/vote
        kubectl rollout restart deployment/result
        kubectl rollout restart deployment/worker
